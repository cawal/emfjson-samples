Using emfjson in Eclipse plugins
---

These examples shows how to use JSON files instead of XMI files in plugins generated by the EMF generator.

Table of contents
- [Setup](#setup)
- [How to use emfjson with the default EMF generator](#how-to-use-emfjson-with-the-default-emf-generator)
- [How to use emfjson with the Xcore generator](#how-to-use-emfjson-with-the-xcore-generator)

# Setup

Before starting make sure your Eclipse installation contains the required plugins. To make these examples work, we 
will need these plugins:

- EMF SDK
- Xcore SDK
- EMFJson Jackson

You can install the EMF and Xcore SDK from the default update site. To do that, in Eclipse got to the menu 
`Help > Install New Software...`, select the default update site for your Eclipse installation, and under the Modeling 
 category, select EMF and Xcore SDKs, as shown in the screenshot below.
 
![update-site-emf](https://dl.dropboxusercontent.com/u/43033733/emfjson-samples/update-site-emf.png)

Once those are installed, you will need to add to repeat the same steps to add emfjson-jackson. But we will use a 
different update site for that. We recommend using Eclipse Mars, because with this version of Eclipse the correct version 
of Jackson (a dependency required by emfjson-jackson) can be install out of the box.
 
> If you are using another version of Eclipse (< 4.5), no worries you will simply need to add another update site before trying 
 to install emfjson-jackson. In the update manager, click on `Add...` and enter the following update site 
 [http://download.eclipse.org/tools/orbit/downloads/drops/R20150519210750/repository/](http://download.eclipse.org/tools/orbit/downloads/drops/R20150519210750/repository/).
 
In the update manager, click the `Add...` button and enter the update site for emfjson [http://ghillairet.github.io/p2](http://ghillairet.github.io/p2).
Now select EMFJson, like shown in the screenshot below.

![update-site-emfjson](https://dl.dropboxusercontent.com/u/43033733/emfjson-samples/update-site-emfjson.png)

Now you are ready for the next steps.

# How to use emfjson with the default EMF generator

We will now create a new EMF project. For that click on `File > New > Project...`. Select `Eclipse Modeling Framework > Empty EMF Project` and click `Next`.
Enter a name for the project, for example `org.emfjson.sample.emf.ui` and click `Finish`.

Your project will contain an empty folder `model`. Create inside it a new file named `model.ecore`. For that select the folder, right click and select 
`New > Other... > Eclipse Modeling Framework > Ecore Model`.

Open the file and start creating your model. You can create the model the way you want, the model used in these examples is shown below. You can 
try to recreate it.

![model](https://dl.dropboxusercontent.com/u/43033733/emfjson-samples/model.png)

Once you finished to create your model, you need to create a generator model that will be use to configure the Ecore code generator. For that, select 
your model file, right click and select `New > Other... > Eclipse Modeling Framework > EMF Generator Model`. The name should be the same as your model.
Click `Next`, select `Ecore Model` then `Next > load > Next` and `Finish`.

Open the `genmodel` file, and make sure that the property `Model > Resource Type` is set to `Basic` for your root package. 
After that select the genmodel's root element, right click and select `Generate All`. This will generate all the code to make the sample EMF plugin working.

Now that the code is generated we will modify the class `ModelResourceImpl` so that it extends `JsonResource`. This is what will make the editor use JSON files instead of XMI files.
Before that we need to add the emfjson-jackson dependency in the `MANIFEST.MF` file.

This file should have the following values for `Require-Bundle`:

```
Require-Bundle: org.eclipse.core.runtime,
 org.eclipse.emf.ecore;visibility:=reexport,
 org.eclipse.emf.ecore.xmi;visibility:=reexport,
 org.emfjson.jackson,
 org.emfjson.core,
 com.fasterxml.jackson.core.jackson-annotations,
 com.fasterxml.jackson.core.jackson-core,
 com.fasterxml.jackson.core.jackson-databind
```

This is what should look like your `ModelResourceImpl` file.

```java
package model.util;

import org.eclipse.emf.common.util.URI;
import org.emfjson.jackson.resource.JsonResource;

/**
 * <!-- begin-user-doc -->
 * The <b>Resource </b> associated with the package.
 * <!-- end-user-doc -->
 * @see model.util.ModelResourceFactoryImpl
 * @generated NOT
 */
public class ModelResourceImpl extends JsonResource {
	/**
	 * Creates an instance of the resource.
	 * <!-- begin-user-doc -->
	 * <!-- end-user-doc -->
	 * @param uri the URI of the new resource.
	 * @generated
	 */
	public ModelResourceImpl(URI uri) {
		super(uri);
	}

} //ModelResourceImpl
```

> Note that it is only one way to modify the default behavior of the editor. 
The Xcore example shows an alternative way to achieve this.

That's all, your generated editor will now use JSON files. To test it, right click on the generated `..editor` project and select `Run As > Eclipse Application`.
This will open a new instance of Eclipse where you can use the generated editor. In the new Eclipse instance, create an empty project. Select this new project, 
right click and select `New > Other... > Example EMF Creation Wizards > Model`, this will create a new file that will contain your model's instances. This should open 
the editor your generated before.

Start to edit your model with the default UI. If you open the file with a text editor, you should see that its content is JSON.

![editor](https://dl.dropboxusercontent.com/u/43033733/emfjson-samples/editor.png)

# How to use emfjson with the Xcore generator

We can achieve the same result when using Xcore, the textual version of EMF. For that you will create a new Xcore project by doing `File > New > Other... > Xcore > New Xcore Project`.
Enter a project name and click `Finish`.

Now create a new xcore file in the empty folder `model`, do `File > New > Other... > File` and create a file named `model.xcore`. Open it and you can 
now create a Xcore model.

This is the model we will use in this example: 

```java
@GenModel(
	complianceLevel="7.0",
	editDirectory="/org.emfjson.sample.xcore.edit/src-gen", 
	editorDirectory="/org.emfjson.sample.xcore.editor/src-gen", 
	resource="None")
package org.emfjson.sample.model

class Library {
	String name
	contains Book[*] books
}

class Book {
	String title
}
```

When saving this file, the code generator will be called to generate the Eclipse editor plugin.
Now we want to modify the generated code to add the support for JSON files. We could use the same approach as before, but instead 
we will use an alternative one that achieves the same result.

In the generated project `...editor`, open the file `plugin.xml` and add the following extension:

```xml
   <extension point="org.eclipse.emf.ecore.extension_parser">
      <parser
            type="model"
            class="org.emfjson.jackson.resource.JsonResourceFactory"/>
   </extension>
```

You will also need to add the emfjson-jackson dependency, like shown before, in the MANIFEST.MF file of that project.

That's it.
